import { __awaiter } from "tslib";
import { Directive, Input, isDevMode } from "@angular/core";
import qrcode from "qrcode";
import * as i0 from "@angular/core";
const validColorRegex = /^#(?:[0-9a-fA-F]{3,4}){1,2}$/;
export class QrCodeDirective {
    constructor(viewContainerRef) {
        this.viewContainerRef = viewContainerRef;
        // eslint-disable-next-line @angular-eslint/no-input-rename
        this.errorCorrectionLevel = QrCodeDirective.DEFAULT_ERROR_CORRECTION_LEVEL;
        this.darkColor = "#000000FF";
        this.lightColor = "#FFFFFFFF";
        // eslint-disable-next-line @angular-eslint/no-input-rename
        this.margin = 16;
    }
    ngOnChanges() {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.value) {
                return;
            }
            if (this.version && this.version > 40) {
                console.warn("[qrCode] max version is 40, clamping");
                this.version = 40;
            }
            else if (this.version && this.version < 1) {
                console.warn("[qrCode] min version is 1, clamping");
                this.version = 1;
            }
            else if (this.version !== undefined && isNaN(this.version)) {
                console.warn("[qrCode] version should be set to a number, defaulting to auto");
                this.version = undefined;
            }
            const canvas = this.viewContainerRef.element.nativeElement;
            if (!canvas) {
                // native element not available on server side rendering
                return;
            }
            const context = canvas.getContext("2d");
            if (context) {
                context.clearRect(0, 0, context.canvas.width, context.canvas.height);
            }
            const errorCorrectionLevel = (_a = this.errorCorrectionLevel) !== null && _a !== void 0 ? _a : QrCodeDirective.DEFAULT_ERROR_CORRECTION_LEVEL;
            const dark = validColorRegex.test(this.darkColor) ? this.darkColor : undefined;
            const light = validColorRegex.test(this.lightColor) ? this.lightColor : undefined;
            if (isDevMode()) {
                if (!dark && this.darkColor) {
                    console.error("[ng-qrcode] darkColor set to invalid value, must be RGBA hex color string, eg: #3050A1FF");
                }
                if (!light && this.lightColor) {
                    console.error("[ng-qrcode] lightColor set to invalid value, must be RGBA hex color string, eg: #3050A130");
                }
            }
            yield qrcode
                .toCanvas(canvas, this.value, {
                version: this.version,
                errorCorrectionLevel,
                width: this.width,
                margin: this.margin,
                color: {
                    dark,
                    light,
                },
            });
            const centerImageSrc = this.centerImageSrc;
            const centerImageWidth = getIntOrDefault(this.centerImageWidth, QrCodeDirective.DEFAULT_CENTER_IMAGE_SIZE);
            const centerImageHeight = getIntOrDefault(this.centerImageHeight, QrCodeDirective.DEFAULT_CENTER_IMAGE_SIZE);
            if (centerImageSrc && context) {
                if (!this.centerImage) {
                    this.centerImage = new Image(centerImageWidth, centerImageHeight);
                }
                if (centerImageSrc !== ((_b = this.centerImage) === null || _b === void 0 ? void 0 : _b.src)) {
                    this.centerImage.src = centerImageSrc;
                }
                if (centerImageWidth !== this.centerImage.width) {
                    this.centerImage.width = centerImageWidth;
                }
                if (centerImageHeight !== this.centerImage.height) {
                    this.centerImage.height = centerImageHeight;
                }
                const centerImage = this.centerImage;
                centerImage.onload = () => {
                    context.drawImage(centerImage, canvas.width / 2 - centerImageWidth / 2, canvas.height / 2 - centerImageHeight / 2, centerImageWidth, centerImageHeight);
                };
            }
        });
    }
}
QrCodeDirective.DEFAULT_ERROR_CORRECTION_LEVEL = "M";
QrCodeDirective.DEFAULT_CENTER_IMAGE_SIZE = 40;
QrCodeDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.10", ngImport: i0, type: QrCodeDirective, deps: [{ token: i0.ViewContainerRef }], target: i0.ɵɵFactoryTarget.Directive });
QrCodeDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.10", type: QrCodeDirective, selector: "canvas[qrCode]", inputs: { value: ["qrCode", "value"], version: ["qrCodeVersion", "version"], errorCorrectionLevel: ["qrCodeErrorCorrectionLevel", "errorCorrectionLevel"], width: "width", height: "height", darkColor: "darkColor", lightColor: "lightColor", centerImageSrc: ["qrCodeCenterImageSrc", "centerImageSrc"], centerImageWidth: ["qrCodeCenterImageWidth", "centerImageWidth"], centerImageHeight: ["qrCodeCenterImageHeight", "centerImageHeight"], margin: ["qrCodeMargin", "margin"] }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.10", ngImport: i0, type: QrCodeDirective, decorators: [{
            type: Directive,
            args: [{
                    // eslint-disable-next-line @angular-eslint/directive-selector
                    selector: `canvas[qrCode]`,
                }]
        }], ctorParameters: function () { return [{ type: i0.ViewContainerRef }]; }, propDecorators: { value: [{
                type: Input,
                args: ["qrCode"]
            }], version: [{
                type: Input,
                args: ["qrCodeVersion"]
            }], errorCorrectionLevel: [{
                type: Input,
                args: ["qrCodeErrorCorrectionLevel"]
            }], width: [{
                type: Input
            }], height: [{
                type: Input
            }], darkColor: [{
                type: Input
            }], lightColor: [{
                type: Input
            }], centerImageSrc: [{
                type: Input,
                args: ["qrCodeCenterImageSrc"]
            }], centerImageWidth: [{
                type: Input,
                args: ["qrCodeCenterImageWidth"]
            }], centerImageHeight: [{
                type: Input,
                args: ["qrCodeCenterImageHeight"]
            }], margin: [{
                type: Input,
                args: ["qrCodeMargin"]
            }] } });
function getIntOrDefault(value, defaultValue) {
    if (value === undefined || value === "") {
        return defaultValue;
    }
    if (typeof value === "string") {
        return parseInt(value, 10);
    }
    return value;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXItY29kZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1xcmNvZGUvc3JjL2xpYi9xci1jb2RlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUErQixNQUFNLGVBQWUsQ0FBQTtBQUN4RixPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUE7O0FBRzNCLE1BQU0sZUFBZSxHQUFHLDhCQUE4QixDQUFBO0FBTXRELE1BQU0sT0FBTyxlQUFlO0lBK0IxQixZQUNVLGdCQUFrQztRQUFsQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBckI1QywyREFBMkQ7UUFDdEIseUJBQW9CLEdBQStCLGVBQWUsQ0FBQyw4QkFBOEIsQ0FBQTtRQUk3SCxjQUFTLEdBQWMsV0FBVyxDQUFBO1FBQ2xDLGVBQVUsR0FBYyxXQUFXLENBQUE7UUFTNUMsMkRBQTJEO1FBQ3BDLFdBQU0sR0FBRyxFQUFFLENBQUE7SUFPbEMsQ0FBQztJQUVLLFdBQVc7OztZQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO2dCQUNmLE9BQU07YUFDUDtZQUVELElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsRUFBRTtnQkFDckMsT0FBTyxDQUFDLElBQUksQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFBO2dCQUNwRCxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQTthQUNsQjtpQkFBTSxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLEVBQUU7Z0JBQzNDLE9BQU8sQ0FBQyxJQUFJLENBQUMscUNBQXFDLENBQUMsQ0FBQTtnQkFDbkQsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUE7YUFDakI7aUJBQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFL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QUFvQjtJQUMvRSxJQUFJLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxLQUFLLEVBQUUsRUFBRTtRQUN2QyxPQUFPLFlBQVksQ0FBQTtLQUNwQjtJQUVELElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO1FBQzdCLE9BQU8sUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQTtLQUMzQjtJQUVELE9BQU8sS0FBSyxDQUFBO0FBQ2QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSW5wdXQsIGlzRGV2TW9kZSwgT25DaGFuZ2VzLCBWaWV3Q29udGFpbmVyUmVmIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIlxuaW1wb3J0IHFyY29kZSBmcm9tIFwicXJjb2RlXCJcbmltcG9ydCB7IFFyQ29kZUVycm9yQ29ycmVjdGlvbkxldmVsLCBSR0JBQ29sb3IgfSBmcm9tIFwiLi90eXBlc1wiXG5cbmNvbnN0IHZhbGlkQ29sb3JSZWdleCA9IC9eIyg/OlswLTlhLWZBLUZdezMsNH0pezEsMn0kL1xuXG5ARGlyZWN0aXZlKHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9kaXJlY3RpdmUtc2VsZWN0b3JcbiAgc2VsZWN0b3I6IGBjYW52YXNbcXJDb2RlXWAsXG59KVxuZXhwb3J0IGNsYXNzIFFyQ29kZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcyB7XG5cbiAgc3RhdGljIHJlYWRvbmx5IERFRkFVTFRfRVJST1JfQ09SUkVDVElPTl9MRVZFTDogUXJDb2RlRXJyb3JDb3JyZWN0aW9uTGV2ZWwgPSBcIk1cIlxuICBzdGF0aWMgcmVhZG9ubHkgREVGQVVMVF9DRU5URVJfSU1BR0VfU0laRSA9IDQwXG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWVcbiAgQElucHV0KFwicXJDb2RlXCIpIHZhbHVlITogc3RyaW5nXG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWVcbiAgQElucHV0KFwicXJDb2RlVmVyc2lvblwiKSB2ZXJzaW9uPzogbnVtYmVyXG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWVcbiAgQElucHV0KFwicXJDb2RlRXJyb3JDb3JyZWN0aW9uTGV2ZWxcIikgZXJyb3JDb3JyZWN0aW9uTGV2ZWw6IFFyQ29kZUVycm9yQ29ycmVjdGlvbkxldmVsID0gUXJDb2RlRGlyZWN0aXZlLkRFRkFVTFRfRVJST1JfQ09SUkVDVElPTl9MRVZFTFxuXG4gIEBJbnB1dCgpIHdpZHRoPzogbnVtYmVyXG4gIEBJbnB1dCgpIGhlaWdodD86IG51bWJlclxuICBASW5wdXQoKSBkYXJrQ29sb3I6IFJHQkFDb2xvciA9IFwiIzAwMDAwMEZGXCJcbiAgQElucHV0KCkgbGlnaHRDb2xvcjogUkdCQUNvbG9yID0gXCIjRkZGRkZGRkZcIlxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lXG4gIEBJbnB1dChcInFyQ29kZUNlbnRlckltYWdlU3JjXCIpIGNlbnRlckltYWdlU3JjPzogc3RyaW5nXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lXG4gIEBJbnB1dChcInFyQ29kZUNlbnRlckltYWdlV2lkdGhcIikgY2VudGVySW1hZ2VXaWR0aD86IG51bWJlciB8IHN0cmluZ1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L25vLWlucHV0LXJlbmFtZVxuICBASW5wdXQoXCJxckNvZGVDZW50ZXJJbWFnZUhlaWdodFwiKSBjZW50ZXJJbWFnZUhlaWdodD86IG51bWJlciB8IHN0cmluZ1xuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lXG4gIEBJbnB1dChcInFyQ29kZU1hcmdpblwiKSBtYXJnaW4gPSAxNlxuXG4gIHByaXZhdGUgY2VudGVySW1hZ2U/OiBIVE1MSW1hZ2VFbGVtZW50XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB2aWV3Q29udGFpbmVyUmVmOiBWaWV3Q29udGFpbmVyUmVmLFxuICApIHtcbiAgfVxuXG4gIGFzeW5jIG5nT25DaGFuZ2VzKCkge1xuICAgIGlmICghdGhpcy52YWx1ZSkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKHRoaXMudmVyc2lvbiAmJiB0aGlzLnZlcnNpb24gPiA0MCkge1xuICAgICAgY29uc29sZS53YXJuKFwiW3FyQ29kZV0gbWF4IHZlcnNpb24gaXMgNDAsIGNsYW1waW5nXCIpXG4gICAgICB0aGlzLnZlcnNpb24gPSA0MFxuICAgIH0gZWxzZSBpZiAodGhpcy52ZXJzaW9uICYmIHRoaXMudmVyc2lvbiA8IDEpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIltxckNvZGVdIG1pbiB2ZXJzaW9uIGlzIDEsIGNsYW1waW5nXCIpXG4gICAgICB0aGlzLnZlcnNpb24gPSAxXG4gICAgfSBlbHNlIGlmICh0aGlzLnZlcnNpb24gIT09IHVuZGVmaW5lZCAmJiBpc05hTih0aGlzLnZlcnNpb24pKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJbcXJDb2RlXSB2ZXJzaW9uIHNob3VsZCBiZSBzZXQgdG8gYSBudW1iZXIsIGRlZmF1bHRpbmcgdG8gYXV0b1wiKVxuICAgICAgdGhpcy52ZXJzaW9uID0gdW5kZWZpbmVkXG4gICAgfVxuXG4gICAgY29uc3QgY2FudmFzID0gdGhpcy52aWV3Q29udGFpbmVyUmVmLmVsZW1lbnQubmF0aXZlRWxlbWVudCBhcyBIVE1MQ2FudmFzRWxlbWVudCB8IG51bGxcblxuICAgIGlmICghY2FudmFzKSB7XG4gICAgICAvLyBuYXRpdmUgZWxlbWVudCBub3QgYXZhaWxhYmxlIG9uIHNlcnZlciBzaWRlIHJlbmRlcmluZ1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgY29uc3QgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIilcblxuICAgIGlmIChjb250ZXh0KSB7XG4gICAgICBjb250ZXh0LmNsZWFyUmVjdCgwLCAwLCBjb250ZXh0LmNhbnZhcy53aWR0aCwgY29udGV4dC5jYW52YXMuaGVpZ2h0KVxuICAgIH1cblxuICAgIGNvbnN0IGVycm9yQ29ycmVjdGlvbkxldmVsID0gdGhpcy5lcnJvckNvcnJlY3Rpb25MZXZlbCA/PyBRckNvZGVEaXJlY3RpdmUuREVGQVVMVF9FUlJPUl9DT1JSRUNUSU9OX0xFVkVMXG5cbiAgICBjb25zdCBkYXJrID0gdmFsaWRDb2xvclJlZ2V4LnRlc3QodGhpcy5kYXJrQ29sb3IpID8gdGhpcy5kYXJrQ29sb3IgOiB1bmRlZmluZWRcbiAgICBjb25zdCBsaWdodCA9IHZhbGlkQ29sb3JSZWdleC50ZXN0KHRoaXMubGlnaHRDb2xvcikgPyB0aGlzLmxpZ2h0Q29sb3IgOiB1bmRlZmluZWRcblxuICAgIGlmIChpc0Rldk1vZGUoKSkge1xuICAgICAgaWYgKCFkYXJrICYmIHRoaXMuZGFya0NvbG9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJbbmctcXJjb2RlXSBkYXJrQ29sb3Igc2V0IHRvIGludmFsaWQgdmFsdWUsIG11c3QgYmUgUkdCQSBoZXggY29sb3Igc3RyaW5nLCBlZzogIzMwNTBBMUZGXCIpXG4gICAgICB9XG5cbiAgICAgIGlmICghbGlnaHQgJiYgdGhpcy5saWdodENvbG9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJbbmctcXJjb2RlXSBsaWdodENvbG9yIHNldCB0byBpbnZhbGlkIHZhbHVlLCBtdXN0IGJlIFJHQkEgaGV4IGNvbG9yIHN0cmluZywgZWc6ICMzMDUwQTEzMFwiKVxuICAgICAgfVxuICAgIH1cbiAgICBhd2FpdCBxcmNvZGVcbiAgICAgIC50b0NhbnZhcyhjYW52YXMsIHRoaXMudmFsdWUsIHtcbiAgICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uLFxuICAgICAgICBlcnJvckNvcnJlY3Rpb25MZXZlbCxcbiAgICAgICAgd2lkdGg6IHRoaXMud2lkdGgsXG4gICAgICAgIG1hcmdpbjogdGhpcy5tYXJnaW4sXG4gICAgICAgIGNvbG9yOiB7XG4gICAgICAgICAgZGFyayxcbiAgICAgICAgICBsaWdodCxcbiAgICAgICAgfSxcbiAgICAgIH0pXG5cbiAgICBjb25zdCBjZW50ZXJJbWFnZVNyYyA9IHRoaXMuY2VudGVySW1hZ2VTcmNcbiAgICBjb25zdCBjZW50ZXJJbWFnZVdpZHRoID0gZ2V0SW50T3JEZWZhdWx0KHRoaXMuY2VudGVySW1hZ2VXaWR0aCwgUXJDb2RlRGlyZWN0aXZlLkRFRkFVTFRfQ0VOVEVSX0lNQUdFX1NJWkUpXG4gICAgY29uc3QgY2VudGVySW1hZ2VIZWlnaHQgPSBnZXRJbnRPckRlZmF1bHQodGhpcy5jZW50ZXJJbWFnZUhlaWdodCwgUXJDb2RlRGlyZWN0aXZlLkRFRkFVTFRfQ0VOVEVSX0lNQUdFX1NJWkUpXG5cbiAgICBpZiAoY2VudGVySW1hZ2VTcmMgJiYgY29udGV4dCkge1xuXG4gICAgICBpZiAoIXRoaXMuY2VudGVySW1hZ2UpIHtcbiAgICAgICAgdGhpcy5jZW50ZXJJbWFnZSA9IG5ldyBJbWFnZShjZW50ZXJJbWFnZVdpZHRoLCBjZW50ZXJJbWFnZUhlaWdodClcbiAgICAgIH1cblxuICAgICAgaWYgKGNlbnRlckltYWdlU3JjICE9PSB0aGlzLmNlbnRlckltYWdlPy5zcmMpIHtcbiAgICAgICAgdGhpcy5jZW50ZXJJbWFnZS5zcmMgPSBjZW50ZXJJbWFnZVNyY1xuICAgICAgfVxuXG4gICAgICBpZiAoY2VudGVySW1hZ2VXaWR0aCAhPT0gdGhpcy5jZW50ZXJJbWFnZS53aWR0aCkge1xuICAgICAgICB0aGlzLmNlbnRlckltYWdlLndpZHRoID0gY2VudGVySW1hZ2VXaWR0aFxuICAgICAgfVxuXG4gICAgICBpZiAoY2VudGVySW1hZ2VIZWlnaHQgIT09IHRoaXMuY2VudGVySW1hZ2UuaGVpZ2h0KSB7XG4gICAgICAgIHRoaXMuY2VudGVySW1hZ2UuaGVpZ2h0ID0gY2VudGVySW1hZ2VIZWlnaHRcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2VudGVySW1hZ2UgPSB0aGlzLmNlbnRlckltYWdlXG5cbiAgICAgIGNlbnRlckltYWdlLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgY29udGV4dC5kcmF3SW1hZ2UoXG4gICAgICAgICAgY2VudGVySW1hZ2UsXG4gICAgICAgICAgY2FudmFzLndpZHRoIC8gMiAtIGNlbnRlckltYWdlV2lkdGggLyAyLFxuICAgICAgICAgIGNhbnZhcy5oZWlnaHQgLyAyIC0gY2VudGVySW1hZ2VIZWlnaHQgLyAyLCBjZW50ZXJJbWFnZVdpZHRoLCBjZW50ZXJJbWFnZUhlaWdodCxcbiAgICAgICAgKVxuICAgICAgfVxuICAgIH1cblxuICB9XG5cbn1cblxuZnVuY3Rpb24gZ2V0SW50T3JEZWZhdWx0KHZhbHVlOiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQsIGRlZmF1bHRWYWx1ZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IFwiXCIpIHtcbiAgICByZXR1cm4gZGVmYXVsdFZhbHVlXG4gIH1cblxuICBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgcmV0dXJuIHBhcnNlSW50KHZhbHVlLCAxMClcbiAgfVxuXG4gIHJldHVybiB2YWx1ZVxufVxuIl19